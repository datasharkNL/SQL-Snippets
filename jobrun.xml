<?xml version="1.0" encoding="utf-16"?>
<AutoReplacement xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
  <Token>jobrun</Token>
  <Name />
  <CaseSensitive>false</CaseSensitive>
  <SelectReplacement>false</SelectReplacement>
  <Replacement>USE msdb
GO

SET NOCOUNT ON;

DECLARE @iLastRun TINYINT = 1, --Indicates number of last runs for a job
        @iStepID TINYINT = NULL, --If NULL, retrieves all the steps for a given job
        @dtLastRunDate DATE,
        @sJobName VARCHAR(100) = '#';

;WITH LastRun
AS
(
SELECT ROW_NUMBER() OVER(ORDER BY h.run_date DESC) AS [nRun(s)],
       h.run_date
  FROM dbo.sysjobhistory AS h
       INNER JOIN dbo.sysjobs AS j ON h.job_id = j.job_id
 WHERE j.name = @sJobName
 GROUP BY run_date
)
SELECT @dtLastRunDate = CAST(CONVERT(VARCHAR(10), run_date, 101) AS DATE)
  FROM LastRun
 WHERE [nRun(s)] = IIF(@iLastRun &gt; [nRun(s)], [nRun(s)], @iLastRun);

;WITH JobExecution
AS
(
SELECT j.name AS JobName,
       --j.description AS JobDescription,
       h.step_id AS StepID,
       h.step_name AS StepName,
       js.subsystem,
       CAST(STR(h.run_date,8, 0) AS DATE) AS StartDate,
       STUFF(STUFF(RIGHT('000000' + CAST (h.run_time AS VARCHAR(6)) ,6),5,0,':'),3,0,':') StartTime,
       CONVERT(TIME(0), STR(FLOOR(h.run_duration / 10000), 2, 0)
                      + ':' + RIGHT(STR(FLOOR(h.run_duration / 100), 6, 0), 2)
                      + ':' + RIGHT(STR(h.run_duration), 2)) AS [ExecutionTime (HH:MM:SS)],
       CASE H.run_status
            WHEN 0 THEN 'Failed'
            WHEN 1 THEN 'Succeeded'
            WHEN 2 THEN 'Retry'
            WHEN 3 THEN 'Cancelled'
            WHEN 4 THEN 'In Progress'
       END AS ExecutionStatus,
       js.command,
       js.database_name,
       js.output_file_name,
       h.message MessageGenerated
  FROM dbo.sysjobhistory AS h
       INNER JOIN dbo.sysjobs AS j ON h.job_id = j.job_id
       INNER JOIN dbo.sysjobsteps AS js ON j.job_id = js.job_id
              AND h.step_id = js.step_id
)
SELECT *
  FROM JobExecution
 WHERE 1 = 1
   AND StepID = COALESCE(@iStepID, StepID)
   AND ExecutionStatus != 'In Progress'
   AND JobName = @sJobName
   AND StartDate &gt;= @dtLastRunDate
 ORDER BY StartDate, StartTime, StepID;</Replacement>
  <CursorPositionMarker>#</CursorPositionMarker>
</AutoReplacement>
